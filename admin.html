<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Rifa Navide√±a</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
      padding: 15px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #c62828;
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
      font-size: 1.8em;
      font-weight: bold;
      color: #c62828;
    }

    .stat-label {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }

    .tabs {
      display: flex;
      background: white;
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: #f8f9fa;
      border: none;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9em;
    }

    .tab.active {
      background: #c62828;
      color: white;
    }

    .search-bar {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
    }

    .search-bar:focus {
      outline: none;
      border-color: #c62828;
    }

    .content {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      min-height: 300px;
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .numero-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #c62828;
    }

    .numero-item.pagado {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .numero-item.reservado {
      border-left-color: #ffc107;
      background: #fff3cd;
    }

    .numero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .numero {
      font-weight: bold;
      font-size: 1.1em;
      color: #c62828;
    }

    .estado {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .estado.pagado {
      background: #28a745;
      color: white;
    }

    .estado.reservado {
      background: #ffc107;
      color: #856404;
    }

    .info {
      font-size: 0.9em;
      color: #666;
    }

    .fecha {
      font-size: 0.8em;
      color: #999;
      margin-top: 5px;
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.3s;
      flex: 1;
    }

    .btn-reactivar {
      background: #17a2b8;
      color: white;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: #666;
    }

    .empty-state i {
      font-size: 2em;
      margin-bottom: 10px;
      display: block;
    }

    /* Grid de n√∫meros disponibles */
    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      padding: 5px;
    }

    .grid-number {
      padding: 10px 5px;
      text-align: center;
      border: 2px solid #c62828;
      border-radius: 8px;
      font-weight: 600;
      background: white;
      font-size: 0.9em;
    }

    .grid-number.disponible {
      background: #f8f9fa;
      color: #c62828;
    }

    .grid-number.ocupado {
      background: #6c757d;
      color: white;
      border-color: #6c757d;
    }

    @media (max-width: 480px) {
      .numbers-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
      }
      
      .grid-number {
        padding: 8px 3px;
        font-size: 0.85em;
      }
      
      .tab {
        padding: 10px 8px;
        font-size: 0.8em;
      }
      
      .content {
        max-height: 50vh;
      }
    }

    /* Scrollbar personalizado */
    .content::-webkit-scrollbar {
      width: 6px;
    }

    .content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .content::-webkit-scrollbar-thumb {
      background: #c62828;
      border-radius: 10px;
    }

    /* Para pantallas muy altas */
    @media (min-height: 800px) {
      .content {
        max-height: 65vh;
      }
      .btn-marcar-pagado {
  background: #28a745 !important;
  color: white !important;
}

.btn-reactivar {
  background: #17a2b8 !important;
  color: white !important;
}

.actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.75em;
  transition: all 0.3s;
  flex: 1;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéÑ Admin Rifa Navide√±a</h1>
      <p>Panel de control - Edith Malagon</p>
    </header>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-pagados">0</div>
        <div class="stat-label">Pagados</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-reservados">0</div>
        <div class="stat-label">Reservados</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-disponibles">100</div>
        <div class="stat-label">Disponibles</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-recaudado">$0</div>
        <div class="stat-label">Recaudado</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="mostrarTab('pagados')">‚úÖ Pagados</button>
      <button class="tab" onclick="mostrarTab('reservados')">‚è∞ Reservados</button>
      <button class="tab" onclick="mostrarTab('disponibles')">üî¢ Disponibles</button>
      <button class="tab" onclick="mostrarTab('todos')">üìã Todos</button>
    </div>

    <input type="text" class="search-bar" id="search" placeholder="üîç Buscar por nombre, tel√©fono o n√∫mero..." onkeyup="filtrarLista()">

    <div class="content">
      <div id="lista-numeros" class="loading">
        Cargando datos...
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
   // Configuraci√≥n de Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCvNhHpsbjinSUFRK3HTDJCCnVFh4DVoXI",
  authDomain: "rifa-misaga.firebaseapp.com",
  databaseURL: "https://rifa-misaga-default-rtdb.firebaseio.com",
  projectId: "rifa-misaga",
  storageBucket: "rifa-misaga.firebasestorage.app",
  messagingSenderId: "495411826218",
  appId: "1:495411826218:web:5fb2d24364b496d0cfbd53",
  measurementId: "G-CNPG01QT6H"
};

// Inicializar Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let todosLosNumeros = [];
let tabActual = 'pagados';

// Funci√≥n para hacer toda la p√°gina desplazable
function hacerPaginaDesplazable() {
  document.body.style.overflow = 'auto';
  document.documentElement.style.overflow = 'auto';
  
  document.addEventListener('touchmove', function(e) {
  }, { passive: true });
}

// Funci√≥n para mejorar el scroll del contenido
function mejorarScrollContenido() {
  const content = document.querySelector('.content');
  
  content.addEventListener('touchstart', function(e) {
  }, { passive: true });
  
  content.addEventListener('touchmove', function(e) {
  }, { passive: true });
}

// Funci√≥n para actualizar estad√≠sticas
function actualizarEstadisticas() {
  let pagados = 0;
  let reservados = 0;
  let recaudado = 0;

  todosLosNumeros.forEach(numero => {
    if (numero.estado === 'pagado') {
      pagados++;
      recaudado += 10000;
    } else if (numero.estado === 'reservado') {
      reservados++;
    }
  });

  document.getElementById('total-pagados').textContent = pagados;
  document.getElementById('total-reservados').textContent = reservados;
  document.getElementById('total-disponibles').textContent = 100 - (pagados + reservados);
  document.getElementById('total-recaudado').textContent = `$${recaudado.toLocaleString()}`;
}

// Cargar todos los n√∫meros
function cargarDatos() {
  const lista = document.getElementById('lista-numeros');
  lista.innerHTML = '<div class="loading">Cargando datos...</div>';

  db.collection('numeros').orderBy('timestamp', 'desc').get().then(snapshot => {
    todosLosNumeros = [];
    
    snapshot.forEach(doc => {
      const data = doc.data();
      todosLosNumeros.push({
        id: doc.id,
        ...data,
        fecha: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'Sin fecha'
      });
    });

    // Actualizar estad√≠sticas
    actualizarEstadisticas();
    mostrarLista();
    
  }).catch(error => {
    console.error('Error cargando datos:', error);
    document.getElementById('lista-numeros').innerHTML = '<div class="empty-state">‚ùå Error cargando datos</div>';
  });
}

// Mostrar lista seg√∫n la pesta√±a seleccionada
function mostrarLista() {
  let numerosFiltrados = [];

  switch(tabActual) {
    case 'pagados':
      numerosFiltrados = todosLosNumeros.filter(n => n.estado === 'pagado');
      break;
    case 'reservados':
      numerosFiltrados = todosLosNumeros.filter(n => n.estado === 'reservado');
      break;
    case 'todos':
      numerosFiltrados = todosLosNumeros;
      break;
    case 'disponibles':
      mostrarNumerosDisponibles();
      return;
  }

  const lista = document.getElementById('lista-numeros');
  
  if (numerosFiltrados.length === 0) {
    lista.innerHTML = `
      <div class="empty-state">
        üì≠ No hay n√∫meros ${tabActual === 'todos' ? '' : tabActual}
      </div>
    `;
    return;
  }

  lista.innerHTML = numerosFiltrados.map(numero => {
    // Determinar qu√© botones mostrar seg√∫n el estado
    let botones = '';
    
    if (numero.estado === 'reservado') {
      botones = `
        <div class="actions">
          <button class="btn btn-marcar-pagado" onclick="marcarComoPagado('${numero.id}', '${numero.numero}', '${numero.nombre || ''}', '${numero.metodo_pago || 'efectivo'}')">
            ‚úÖ Marcar como Pagado
          </button>
          <button class="btn btn-reactivar" onclick="reactivarNumero('${numero.id}', '${numero.numero}', '${numero.nombre || ''}')">
            üîÑ Reactivar
          </button>
        </div>
      `;
    } else if (numero.estado === 'pagado') {
      botones = `
        <div class="actions">
          <button class="btn btn-reactivar" onclick="reactivarNumero('${numero.id}', '${numero.numero}', '${numero.nombre || ''}')">
            üîÑ Reactivar
          </button>
        </div>
      `;
    }

    return `
      <div class="numero-item ${numero.estado}">
        <div class="numero-header">
          <div class="numero">N√∫mero ${numero.numero}</div>
          <div class="estado ${numero.estado}">
            ${numero.estado === 'pagado' ? '‚úÖ Pagado' : '‚è∞ Reservado'}
          </div>
        </div>
        <div class="info">
          <strong>${numero.nombre || 'Sin nombre'}</strong><br>
          üìû ${numero.telefono || 'Sin tel√©fono'}<br>
          üí≥ ${numero.metodo_pago || 'No especificado'}
        </div>
        <div class="fecha">${numero.fecha}</div>
        ${botones}
      </div>
    `;
  }).join('');
}

// Mostrar n√∫meros disponibles
function mostrarNumerosDisponibles() {
  const numerosOcupados = todosLosNumeros.map(n => n.numero);
  const lista = document.getElementById('lista-numeros');
  
  let contenido = '<h3 style="margin-bottom: 15px; color: #c62828; text-align: center;">N√∫meros Disponibles</h3>';
  contenido += '<div class="numbers-grid">';
  
  for (let i = 0; i < 100; i++) {
    const num = i.toString().padStart(2, '0');
    const disponible = !numerosOcupados.includes(num);
    
    contenido += `
      <div class="grid-number ${disponible ? 'disponible' : 'ocupado'}">
        ${num}
      </div>
    `;
  }
  
  contenido += '</div>';
  lista.innerHTML = contenido;
}

// Filtrar lista
function filtrarLista() {
  const searchTerm = document.getElementById('search').value.toLowerCase();
  
  if (tabActual === 'disponibles') return;
  
  const items = document.querySelectorAll('.numero-item');
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
  });
}

// Cambiar pesta√±a
function mostrarTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick="mostrarTab('${tab}')"]`).classList.add('active');
  tabActual = tab;
  mostrarLista();
}

// NUEVA FUNCI√ìN: Marcar como Pagado
async function marcarComoPagado(docId, numero, nombre, metodoPagoActual) {
  // Pedir confirmaci√≥n del m√©todo de pago
  const metodoPago = prompt(
    `üí∞ Marcar n√∫mero ${numero} como PAGADO\n\n` +
    `Cliente: ${nombre || 'Sin nombre'}\n\n` +
    `Selecciona m√©todo de pago:\n` +
    `1 - Efectivo\n` +
    `2 - Nequi\n` +
    `3 - DaviPlata\n\n` +
    `M√©todo actual: ${metodoPagoActual || 'No especificado'}`,
    metodoPagoActual || 'efectivo'
  );

  if (!metodoPago) {
    return; // Usuario cancel√≥
  }

  // Mapear m√©todo de pago
  let metodoPagoFinal = metodoPago.toLowerCase();
  if (metodoPago === '1') metodoPagoFinal = 'efectivo';
  if (metodoPago === '2') metodoPagoFinal = 'nequi';
  if (metodoPago === '3') metodoPagoFinal = 'daviplata';

  if (confirm(`¬øConfirmas que el n√∫mero ${numero} ha sido PAGADO?\n\n` +
             `Cliente: ${nombre || 'Sin nombre'}\n` +
             `M√©todo: ${metodoPagoFinal}\n\n` +
             `‚úÖ Se cambiar√° a estado PAGADO\n` +
             `‚úÖ Se actualizar√° en Firebase`)) {
    try {
      console.log(`üí∞ Marcando como pagado: ${numero}`);
      
      // 1. ACTUALIZAR en colecci√≥n "numeros"
      await db.collection('numeros').doc(docId).update({
        estado: 'pagado',
        metodo_pago: metodoPagoFinal,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log(`‚úÖ Actualizado en "numeros": ${numero} ‚Üí PAGADO`);
      
      // 2. ACTUALIZAR en colecci√≥n "compradores"
      const compradoresSnapshot = await db.collection('compradores')
        .where('numeros', 'array-contains', numero)
        .get();
      
      let compradoresActualizados = 0;
      const batch = db.batch();
      
      compradoresSnapshot.forEach(doc => {
        const data = doc.data();
        if (data.numeros && data.numeros.includes(numero)) {
          batch.update(doc.ref, {
            estado: 'pagado',
            metodo_pago: metodoPagoFinal,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          compradoresActualizados++;
          console.log(`‚úÖ Actualizando en "compradores": ${doc.id}`);
        }
      });
      
      if (compradoresActualizados > 0) {
        await batch.commit();
        console.log(`‚úÖ Actualizados ${compradoresActualizados} registros en "compradores"`);
      }
      
      // 3. ACTUALIZAR interfaz local
      const numeroIndex = todosLosNumeros.findIndex(n => n.id === docId);
      if (numeroIndex !== -1) {
        todosLosNumeros[numeroIndex].estado = 'pagado';
        todosLosNumeros[numeroIndex].metodo_pago = metodoPagoFinal;
        todosLosNumeros[numeroIndex].fecha = new Date().toLocaleString();
      }
      
      // 4. ACTUALIZAR estad√≠sticas
      actualizarEstadisticas();
      
      // 5. MOSTRAR mensaje de √©xito
      let mensaje = `‚úÖ N√∫mero ${numero} marcado como PAGADO\n`;
      mensaje += `üí≥ M√©todo: ${metodoPagoFinal}\n`;
      if (compradoresActualizados > 0) {
        mensaje += `üìä Actualizado en ${compradoresActualizados} registro(s)`;
      }
      alert(mensaje);
      
      // 6. RECARGAR lista
      mostrarLista();
      
      console.log(`üéØ Pago registrado correctamente para n√∫mero ${numero}`);
      
    } catch (error) {
      console.error('‚ùå Error marcando como pagado:', error);
      alert('‚ùå Error marcando como pagado: ' + error.message);
    }
  }
}

// Reactivar n√∫mero
async function reactivarNumero(docId, numero, nombre) {
  if (confirm(`¬øEst√°s segura de reactivar el n√∫mero ${numero}?\n\nCliente: ${nombre || 'Sin nombre'}\n\n‚úÖ Se eliminar√° de "numeros" y "compradores"\n‚úÖ Volver√° a estar DISPONIBLE en la rifa`)) {
    try {
      console.log(`üîÑ Iniciando reactivaci√≥n del n√∫mero ${numero}`);
      
      // 1. ELIMINAR de la colecci√≥n "numeros"
      await db.collection('numeros').doc(docId).delete();
      console.log(`‚úÖ Eliminado de "numeros": ${numero}`);
      
      // 2. BUSCAR y ELIMINAR de la colecci√≥n "compradores"
      const compradoresSnapshot = await db.collection('compradores')
        .where('numeros', 'array-contains', numero)
        .get();
      
      let compradoresEliminados = 0;
      const batch = db.batch();
      
      compradoresSnapshot.forEach(doc => {
        const data = doc.data();
        // Verificar que este documento contenga exactamente este n√∫mero
        if (data.numeros && data.numeros.includes(numero)) {
          batch.delete(doc.ref);
          compradoresEliminados++;
          console.log(`‚úÖ Eliminando de "compradores": ${doc.id}`);
        }
      });
      
      if (compradoresEliminados > 0) {
        await batch.commit();
        console.log(`‚úÖ Eliminados ${compradoresEliminados} registros de "compradores"`);
      }
      
      // 3. ACTUALIZAR interfaz local
      const index = todosLosNumeros.findIndex(n => n.id === docId);
      if (index !== -1) {
        todosLosNumeros.splice(index, 1);
      }
      
      // 4. ACTUALIZAR estad√≠sticas
      actualizarEstadisticas();
      
      // 5. MOSTRAR mensaje de √©xito
      let mensaje = `‚úÖ N√∫mero ${numero} reactivado correctamente`;
      if (compradoresEliminados > 0) {
        mensaje += `\nüóëÔ∏è Eliminado de ${compradoresEliminados} registro(s) en compradores`;
      }
      alert(mensaje);
      
      // 6. RECARGAR lista
      mostrarLista();
      
      console.log(`üéØ Reactivaci√≥n completada para n√∫mero ${numero}`);
      
    } catch (error) {
      console.error('‚ùå Error en reactivaci√≥n:', error);
      alert('‚ùå Error reactivando n√∫mero: ' + error.message);
    }
  }
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
  hacerPaginaDesplazable();
  mejorarScrollContenido();
  cargarDatos();
  setInterval(cargarDatos, 30000);
});

// Pull to refresh mejorado
let touchStartY = 0;
let isScrolling = false;

document.addEventListener('touchstart', e => {
  touchStartY = e.touches[0].clientY;
  isScrolling = false;
});

document.addEventListener('touchmove', e => {
  isScrolling = true;
});

document.addEventListener('touchend', e => {
  if (!isScrolling) return;
  
  const touchEndY = e.changedTouches[0].clientY;
  if (window.scrollY === 0 && touchStartY - touchEndY > 100) {
    cargarDatos();
  }
});
  </script>
</body>
</html>
